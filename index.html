<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D Floor Plan to 3D Model</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Mobile Console Debugger (Remove after debugging) -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        // Only show console on mobile devices
        if (window.innerWidth < 1025) {
            eruda.init();
        }
    </script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
  <!-- LEFT SIDEBAR - 2D Floor Plan Tools -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>2D Floor Plan</h2>
      <button id="sidebar-toggle" class="icon-btn" title="Toggle Sidebar">
        ‚ò∞
      </button>
    </div>

    <!-- Drawing Tools Section -->
    <div class="sidebar-section">
      <h3 class="section-title">Drawing Tools</h3>
      <div class="tool-grid">
        <button id="mode-draw" class="tool-btn active" title="Draw Walls">
          <span class="tool-icon">‚úèÔ∏è</span>
          <span class="tool-label">Draw Walls</span>
        </button>
        <button id="mode-edit" class="tool-btn" title="Edit">
          <span class="tool-icon">‚úÇÔ∏è</span>
          <span class="tool-label">Edit</span>
        </button>
        <button id="mode-door" class="tool-btn" title="Add Doors">
          <span class="tool-icon">üö™</span>
          <span class="tool-label">Doors</span>
        </button>
        <button id="mode-window" class="tool-btn" title="Add Windows">
          <span class="tool-icon">ü™ü</span>
          <span class="tool-label">Windows</span>
        </button>
        <button id="mode-patio" class="tool-btn" title="Add Patio">
          <span class="tool-icon">üè°</span>
          <span class="tool-label">Patio</span>
        </button>
      </div>
    </div>

    <!-- Floor Management Section -->
    <div class="sidebar-section">
      <h3 class="section-title">Floor Management</h3>
      <div class="input-group">
        <label>Current Floor:</label>
        <select id="floor-selector">
          <option value="0" selected>Floor 1</option>
        </select>
      </div>
      <button id="add-floor" class="btn-secondary full-width">+ Add Floor</button>
      <label class="checkbox-label">
        <input type="checkbox" id="show-floor-overlay" checked>
        <span>Show Floor Below</span>
      </label>
    </div>

    <!-- Door Style Section -->
    <div class="sidebar-section">
      <h3 class="section-title">Door Style</h3>
      <div class="input-group">
        <select id="door-style">
          <option value="swing" selected>Swing Door (3')</option>
          <option value="pocket">Pocket Door (3')</option>
          <option value="bifold">Bifold Door (4')</option>
          <option value="double">Double Door (6')</option>
        </select>
      </div>
    </div>

    <!-- Patio Options Section -->
    <div class="sidebar-section">
      <h3 class="section-title">Patio Options</h3>
      
      <label class="checkbox-label">
        <input type="checkbox" id="patio-has-roof">
        <span>Add Roof to Patio</span>
      </label>
      
      <div class="input-group">
        <label>Patio Roof Style:</label>
        <select id="patio-roof-style">
          <option value="flat" selected>Flat Roof</option>
          <option value="gable">Gable Roof</option>
          <option value="hip">Hip Roof</option>
        </select>
      </div>
    </div>

    <!-- AI Enhancement Section -->
    <div class="sidebar-section">
      <h3 class="section-title">AI Enhancement</h3>
      <button id="upscale-3d-btn" class="btn-primary full-width">
        <span>üì∏</span>
        <span>Upscale 3D Model</span>
      </button>
      <p id="upscale-status" style="font-size: 12px; margin-top: 8px; color: #6b7280; text-align: center; min-height: 18px;"></p>
      <div style="margin-top: 12px; padding: 12px; background: #f0f4ff; border-radius: 8px; font-size: 11px; color: #667eea;">
        <strong>‚ú® AI-Powered Upscaling</strong>
        <p style="margin: 4px 0 0 0; color: #6b7280;">Captures your 3D model and enhances it using AI for photorealistic quality.</p>
      </div>
    </div>

    <!-- Actions Section -->
    <div class="sidebar-section">
      <h3 class="section-title">Actions</h3>
      <button id="clear-plan" class="btn-danger full-width">Clear Plan</button>
      <button id="undo" class="btn-secondary full-width">Undo</button>
      <button id="export-design" class="btn-secondary full-width">Export Design</button>
    </div>
  </div>

  <!-- TOP TOOLBAR - 3D Controls (OUTSIDE main-content) -->
  <div class="top-toolbar">
    <div class="toolbar-left">
      <h1 class="app-title">Floor Plan to 3D</h1>
    </div>

    <div class="toolbar-center">
      <!-- 3D View Controls Group -->
      <div class="control-group">
        <span class="group-label">3D VIEW</span>
        <label class="checkbox-inline">
          <input type="checkbox" id="show-roof" checked>
          <span>Show Roof</span>
        </label>
      </div>

      <!-- Wall Height Control -->
      <div class="control-group">
        <label class="slider-label">
          <span>Wall Height:</span>
          <span id="wall-height-value" class="value-display">8ft</span>
        </label>
        <input type="range" id="wall-height" min="8" max="12" step="0.5" value="8" class="slider">
      </div>

      <!-- Has Roof Checkbox -->
      <div class="control-group">
        <label class="checkbox-inline">
          <input type="checkbox" id="floor-has-roof">
          <span>Add Roof to This Floor</span>
        </label>
      </div>

      <!-- Roof Style Dropdown -->
      <div class="control-group">
        <label>Roof Style (Current Floor):</label>
        <select id="roof-style" class="compact-select">
          <option value="hip" selected>Hip Roof</option>
          <option value="gable">Gable Roof</option>
          <option value="flat">Flat Roof</option>
        </select>
      </div>

      <!-- Roof Pitch Slider -->
      <div class="control-group">
        <label class="slider-label">
          <span>Pitch (Current Floor):</span>
          <span id="roof-pitch-value" class="value-display">6:12</span>
        </label>
        <input type="range" id="roof-pitch" min="4" max="12" step="1" value="6" class="slider">
      </div>

      <!-- Overhang Slider -->
      <div class="control-group">
        <label class="slider-label">
          <span>Overhang (Current Floor):</span>
          <span id="roof-overhang-value" class="value-display">1.0 ft</span>
        </label>
        <input type="range" id="roof-overhang" min="0" max="3" step="0.5" value="1" class="slider">
      </div>
    </div>

    <div class="toolbar-right">
      <button id="regenerate-3d" class="btn-primary">
        <span>üîÑ</span>
        <span>Update 3D</span>
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT AREA -->
  <div class="main-content">
    <!-- SPLIT VIEW CONTAINER -->
    <div class="split-container">
      <!-- LEFT: 2D Canvas -->
      <div class="canvas-container-2d">
        <canvas id="floor-plan-canvas"></canvas>
        <div class="canvas-info">
          <p>üìè Walls: <span id="wall-count">0</span> | Length: <span id="total-length">0</span> ft</p>
        </div>
      </div>

      <!-- RIGHT: 3D Viewer -->
      <div class="canvas-container-3d">
        <canvas id="three-canvas"></canvas>
        <div class="canvas-info-3d">
          <div class="info-title">üéÆ 3D Controls</div>
          <ul class="control-list">
            <li>Left Click + Drag: Rotate</li>
            <li>Right Click + Drag: Pan</li>
            <li>Scroll: Zoom</li>
          </ul>
        </div>
        <div class="stats-panel">
          <div class="stats-title">üìä Model Stats</div>
          <div class="stat-row">
            <span class="stat-label">Floors:</span>
            <span class="stat-value" id="stat-floors">1</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Walls:</span>
            <span class="stat-value" id="stat-walls">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Doors:</span>
            <span class="stat-value" id="stat-doors">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Windows:</span>
            <span class="stat-value" id="stat-windows">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE LAYOUT (shown only on screens < 1025px) -->
  <div class="mobile-layout">
    <!-- Top Header Bar -->
    <div class="mobile-header">
      <button id="mobile-menu-btn" class="mobile-icon-btn" aria-label="Open Menu">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
      </button>
      <h1 class="mobile-title">Floor Planner</h1>
      <button id="mobile-options-btn" class="mobile-icon-btn" aria-label="Options">
        <svg width="24" height="24" fill="currentColor">
          <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
        </svg>
      </button>
    </div>

    <!-- Canvas Container (Full Screen) -->
    <div class="mobile-canvas-container">
      <canvas id="mobile-canvas-2d"></canvas>
      <canvas id="mobile-canvas-3d"></canvas>
      
      <!-- 2D/3D View Toggle (Floating) -->
      <div class="view-switcher">
        <button class="view-btn active" data-view="2d">
          <span>üìê</span>
          <span>2D Plan</span>
        </button>
        <button class="view-btn" data-view="3d">
          <span>üè†</span>
          <span>3D View</span>
        </button>
      </div>

      <!-- 3D Controls Hint -->
      <div class="controls-hint" style="display: none;">
        <p>üëÜ Pinch to zoom ‚Ä¢ Drag to rotate</p>
      </div>
    </div>

    <!-- Bottom Tool Sheet -->
    <div class="bottom-sheet" id="mobile-tools-sheet">
      <div class="sheet-handle"></div>
      
      <div class="sheet-header">
        <h3 class="sheet-title">Tools</h3>
        <button class="sheet-close" aria-label="Close">‚úï</button>
      </div>

      <!-- Tool Tabs -->
      <div class="tool-tabs">
        <button class="tab-btn active" data-tab="draw">
          <span class="tab-icon">‚úèÔ∏è</span>
          <span class="tab-label">Draw</span>
        </button>
        <button class="tab-btn" data-tab="doors">
          <span class="tab-icon">üö™</span>
          <span class="tab-label">Doors</span>
        </button>
        <button class="tab-btn" data-tab="settings">
          <span class="tab-icon">‚öôÔ∏è</span>
          <span class="tab-label">Settings</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content-container">
        <!-- DRAW TAB -->
        <div class="tab-content active" data-content="draw">
          <div class="mobile-tool-grid">
            <button class="mobile-tool-btn active" data-mode="draw">
              <span class="tool-icon-large">‚úèÔ∏è</span>
              <span class="tool-name">Draw Walls</span>
            </button>
            <button class="mobile-tool-btn" data-mode="edit">
              <span class="tool-icon-large">‚úÇÔ∏è</span>
              <span class="tool-name">Edit</span>
            </button>
            <button class="mobile-tool-btn" data-mode="patio">
              <span class="tool-icon-large">üè°</span>
              <span class="tool-name">Add Patio</span>
            </button>
          </div>
          <button id="mobile-clear-plan" class="mobile-btn-danger full-width">Clear Plan</button>
          <button id="mobile-undo" class="mobile-btn-secondary full-width">Undo Last</button>
        </div>

        <!-- DOORS TAB -->
        <div class="tab-content" data-content="doors">
          <button class="mobile-tool-btn-wide active" data-mode="door">
            <span>üö™</span> Place Doors
          </button>
          <div class="mobile-input-group">
            <label>Door Style:</label>
            <select id="mobile-door-style" class="mobile-select">
              <option value="swing">Swing Door (3')</option>
              <option value="pocket">Pocket Door (3')</option>
              <option value="bifold">Bifold Door (4')</option>
              <option value="double">Double Door (6')</option>
            </select>
          </div>
          <button class="mobile-tool-btn-wide" data-mode="window">
            <span>ü™ü</span> Place Windows
          </button>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-content" data-content="settings">
          <div class="mobile-input-group">
            <label>Floor:</label>
            <select id="mobile-floor-selector" class="mobile-select">
              <option value="0">Floor 1</option>
            </select>
          </div>
          <button id="mobile-add-floor" class="mobile-btn-secondary full-width">+ Add Floor</button>
          
          <div class="mobile-input-group">
            <label>Wall Height: <span id="mobile-wall-height-value">8 ft</span></label>
            <input type="range" id="mobile-wall-height" min="8" max="12" step="0.5" value="8" class="mobile-slider">
          </div>

          <div class="mobile-checkbox-group">
            <label class="mobile-checkbox-label">
              <input type="checkbox" id="mobile-show-roof" checked>
              <span>Show Roof</span>
            </label>
            <label class="mobile-checkbox-label">
              <input type="checkbox" id="mobile-show-floor-overlay" checked>
              <span>Show Floor Below</span>
            </label>
          </div>

          <div class="mobile-input-group">
            <label>Roof Style:</label>
            <select id="mobile-roof-style" class="mobile-select">
              <option value="hip">Hip Roof</option>
              <option value="gable">Gable Roof</option>
              <option value="flat">Flat Roof</option>
            </select>
          </div>

          <button id="mobile-export-design" class="mobile-btn-secondary full-width">üì• Export Design</button>

          <!-- AI Enhancement for Mobile -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
            <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">
              ‚ú® AI Enhancement
            </h4>
            <button id="mobile-upscale-3d" class="mobile-btn-secondary full-width" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; font-size: 16px; font-weight: 700; border: none;">
              üì∏ Upscale 3D Model
            </button>
            <p id="mobile-upscale-status" style="font-size: 12px; margin-top: 8px; text-align: center; color: #6b7280; min-height: 18px;"></p>
            <div style="margin-top: 12px; padding: 12px; background: #f0f4ff; border-radius: 8px; font-size: 11px; color: #667eea;">
              <strong>How it works:</strong>
              <p style="margin: 4px 0 0 0; color: #6b7280;">Captures current 3D view and sends to AI for enhancement</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="mobile-update-3d" aria-label="Update 3D Model">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
      </svg>
      <span>Update</span>
    </button>

    <!-- Side Menu -->
    <div class="side-menu" id="mobile-side-menu">
      <div class="side-menu-header">
        <h2>Menu</h2>
        <button class="side-menu-close" aria-label="Close Menu">‚úï</button>
      </div>
      <nav class="side-menu-nav">
        <button class="menu-item" data-action="new-plan">
          <span>üìÑ</span> New Plan
        </button>
        <button class="menu-item" data-action="export">
          <span>üì•</span> Export Design
        </button>
        <button class="menu-item" data-action="help">
          <span>‚ùì</span> Help
        </button>
      </nav>
    </div>

    <!-- Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
  </div>

  <!-- Debug Script -->
  <script>
    console.log('=== LAYOUT DEBUG ===');
    console.log('Window size:', window.innerWidth, 'x', window.innerHeight);
    console.log('Device pixel ratio:', window.devicePixelRatio);
    
    setTimeout(() => {
        const mobileLayout = document.querySelector('.mobile-layout');
        const sidebar = document.querySelector('.sidebar');
        const toolbar = document.querySelector('.top-toolbar');
        
        console.log('Mobile layout display:', mobileLayout ? window.getComputedStyle(mobileLayout).display : 'NOT FOUND');
        console.log('Sidebar display:', sidebar ? window.getComputedStyle(sidebar).display : 'NOT FOUND');
        console.log('Toolbar display:', toolbar ? window.getComputedStyle(toolbar).display : 'NOT FOUND');
        console.log('Mobile layout exists?', !!mobileLayout);
        console.log('2D Canvas exists?', !!document.getElementById('mobile-canvas-2d'));
        console.log('3D Canvas exists?', !!document.getElementById('mobile-canvas-3d'));
    }, 500);
  </script>

  <!-- Application Scripts -->
  <script type="module" src="app.js"></script>
  <script type="module" src="mobile-app.js"></script>
</body>
</html>
